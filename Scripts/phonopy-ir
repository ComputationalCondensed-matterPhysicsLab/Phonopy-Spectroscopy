#!/usr/bin/env python


# -------
# Imports
# -------

from argparse import ArgumentParser;

from SpectroscoPy.Interfaces.Phonopy import ReadMeshYAML, ReadIrRepsYAML, ReadBORN, ReadPhono3pyHDF5;

from SpectroscoPy.Utilities import EigenvectorsToEigendisplacements;

from SpectroscoPy.CLI.Parser import UpdateParser, PostProcessArgs;
from SpectroscoPy.CLI.Runtime import RunMode_IR;


# ----
# Main
# ----

if __name__ == "__main__":
    # Parse command-line arguments.

    parser = ArgumentParser(
        description = "Simulate IR spectra using Phonopy calculations"
        );

    # Add input-files argument group.

    group = parser.add_argument_group("Input files");

    group.add_argument(
        "--mesh_yaml",
        metavar = "<file_path>",
        type = str, dest = "MeshYAML",
        default = "mesh.yaml",
        help = "mesh.yaml file to read (default: mesh.yaml)"
        );

    group.add_argument(
        "--born_file",
        metavar = "<file_path>",
        type = str, dest = "BORNFile",
        default = "BORN",
        help = "BORN file to read (default: BORN)"
        );

    group.add_argument(
        "--ir_reps_yaml",
        metavar = "<file_path>",
        type = str, dest = "IrRepsYAML",
        default = "irreps.yaml",
        help = "irreps.yaml file to read if using the --ir_reps argument (default: irreps.yaml)"
        );

    group = parser.add_argument_group("Linewidths");

    group.add_argument(
        "--linewidth_hdf5",
        metavar = "<file_path>",
        type = str, dest = "LinewidthHDF5",
        default = None,
        help = "Read mode linewidths from a Phono3py HDF5 file"
        );

    group.add_argument(
        "--linewidth_temperature",
        metavar = "<temperature>",
        type = float, dest = "LinewidthTemperature",
        default = None,
        help = "Temperature to extract linewidths at"
        );

    # Add standard arguments groups.

    UpdateParser(parser, supportedFeatures = ['ir_reps']);

    # Parse and process arguments.

    args = parser.parse_args();

    PostProcessArgs(args);

    # Read mesh.yaml file.

    meshData = ReadMeshYAML(filePath = args.MeshYAML);

    frequencies, eigenvectors = meshData['gamma_modes'];

    # Convert eigenvectors to eigendisplacements.

    eigendisplacements = EigenvectorsToEigendisplacements(
        eigenvectors, meshData['atomic_masses']
        );

    # Read Born effective-charge tensors.

    becTensors = ReadBORN(meshData['structure'], filePath = args.BORNFile);

    # Read ir. rep. data, if required.

    irRepData = None;

    if args.IrReps:
        irRepData = ReadIrRepsYAML(filePath = args.IrRepsYAML);

    # Read linewidths, if specified.

    linewidths = None;

    if args.LinewidthHDF5:
        if args.LinewidthTemperature == None:
            raise Exception("Error: If reading linewidths from a Phono3py HDF5 file, a temperature must be supplied using the --linewidth_temperature argument.");

        linewidths = ReadPhono3pyHDF5(args.LinewidthHDF5, args.LinewidthTemperature);

    # Hand over to the RunMode_IR() routine.

    RunMode_IR(
        frequencies, 'thz', eigendisplacements, becTensors, args, linewidths = linewidths, irRepData = irRepData
        );
